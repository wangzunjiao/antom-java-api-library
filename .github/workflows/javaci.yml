name: Java CI / Auto Version Update

on:
  push:
    branches:
      - master
      - sdk-automation/**
  pull_request:
    branches:
      - master
      - sdk-automation/**
  workflow_dispatch: { }

jobs:
  # 1. ç¼–è¯‘æ£€æŸ¥ Job
  java-check:
    name: Java Code Check (JDK 11)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      # ... å…¶ä»–æ­¥éª¤ ...
      - name: Compile Code for Errors
        run: mvn -B compile --no-transfer-progress

  # 2. æ„å»ºå’Œæµ‹è¯• Job
  java-test:
    name: Build and Test (${{ matrix.java }})
    runs-on: ubuntu-latest
    needs: java-check # ä¾èµ–äº java-check å¿…é¡»æˆåŠŸ
    strategy:
      matrix:
        java: [ '8', '11', '17', '20' ]
    steps:
      - uses: actions/checkout@v4
      # ... å…¶ä»–æ­¥éª¤ ...
      - name: Run tests with coverage
        run: mvn -B clean test package --no-transfer-progress

  # 3. è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬ Job
  version-bump:
    name: Auto Bump Version and Commit
    runs-on: ubuntu-latest
    # è¿™ä¸€æ­¥å¿…é¡»ä¾èµ–å‰é¢çš„æ‰€æœ‰æµ‹è¯•ï¼Œç¡®ä¿åªæœ‰åœ¨ä»£ç æˆåŠŸé€šè¿‡æµ‹è¯•åæ‰æ›´æ–°ç‰ˆæœ¬
    needs: [ java-check, java-test ]

    # ä»…åœ¨æ¨é€åˆ° master åˆ†æ”¯æ—¶è¿è¡Œï¼Œé¿å…åœ¨ PR æˆ–å…¶ä»–åˆ†æ”¯ä¸Šè‡ªåŠ¨æäº¤
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»ä½¿ç”¨ token æ‰èƒ½æäº¤
          token: ${{ secrets.ADYEN_AUTOMATION_BOT_ACCESS_TOKEN }}

      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: 3. Update POM and Extract New Version
        # ä¿®æ”¹åçš„ run è„šæœ¬ï¼šè®¡ç®—æ–°ç‰ˆæœ¬ X.Y.Z+1
        run: |
          echo "--- Updating pom.xml to next release version ---"
          # 1. æå–å½“å‰ç‰ˆæœ¬å· (å‡è®¾å½“å‰æ˜¯ 2.1.1)
          CURRENT_VERSION=$(grep -m 1 '<version>' pom.xml | awk -F'[<>]' '/version/{print $3}')
          echo "Current Version: ${CURRENT_VERSION}"
          
          # 2. åˆ†å‰²ç‰ˆæœ¬å·å¹¶é€’å¢ Z (æœ€åä¸€ä¸ªæ•°å­—)
          MAJOR_MINOR=$(echo ${CURRENT_VERSION} | awk -F'.' '{print $1"."$2}')
          PATCH=$(echo ${CURRENT_VERSION} | awk -F'.' '{print $3}')
          NEXT_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR_MINOR}.${NEXT_PATCH}"
          echo "Calculated New Version: ${NEW_VERSION}"
          
          # 3. ä½¿ç”¨æ–°çš„ç‰ˆæœ¬å·æ›´æ–° pom.xml (æ³¨æ„è¿™é‡Œä¸å†ä½¿ç”¨ -DnextSnapshot=true)
          mvn versions:set -DnewVersion=${NEW_VERSION} -B
          mvn versions:commit -B
          
          # 4. è®¾ç½®ç¯å¢ƒå˜é‡
          echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV
          echo "New Version: ${NEW_VERSION} has been set."

      - name: 4. Update Version in README File (Regex adjusted)
        run: |
          echo "--- Updating README file ---"
          README_FILE="README.md"
          NEW_VERSION_SHELL="${{ env.NEW_VERSION }}"
          
          # åŒ¹é… <version> å’Œ </version> ä¹‹é—´å¯èƒ½å­˜åœ¨çš„ä»»ä½•éæ¢è¡Œå­—ç¬¦
          sed -i "s#<version>.*</version>#<version>$NEW_VERSION_SHELL</version>#g" $README_FILE
          
          echo "Successfully updated version in $README_FILE."

      - name: 5. Commit and Push the updated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(release): Bump version to ${{ env.NEW_VERSION }} [skip ci]"
          files: |
            pom.xml
            README.md
          commit_options: '--no-verify'
      - name: 6. Create and Push Version Tag ğŸŒŸ (æ–°å¢æ­¥éª¤)
        if: steps.commit_push.outputs.changes_detected == 'true'
        run: |
          # çº¦å®š Tag æ ¼å¼ä¸º vX.Y.Z
          TAG_NAME="v${{ env.NEW_VERSION }}"
          
          echo "Creating Tag: $TAG_NAME"
          # 1. åˆ›å»ºæœ¬åœ° Tagï¼ŒæŒ‡å‘æœ€æ–°çš„ commit
          git tag -a $TAG_NAME -m "Release version ${{ env.NEW_VERSION }}"
          
          # 2. æ¨é€ Tag
          # ç”±äº Step 1 å·²ç»é…ç½®äº†è®¤è¯ï¼Œå¯ä»¥ç›´æ¥æ¨é€
          git push origin $TAG_NAME

        env:
          # ç¡®ä¿ Git æ“ä½œä½¿ç”¨æ­£ç¡®çš„è®¤è¯ä¿¡æ¯
          GITHUB_TOKEN: ${{ secrets.ADYEN_AUTOMATION_BOT_ACCESS_TOKEN }}
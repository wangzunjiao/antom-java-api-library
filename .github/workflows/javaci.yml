name: Java CI / Auto Version Update

on:
  push:
    branches:
      - master
      - sdk-automation/**
  pull_request:
    branches:
      - master
      - sdk-automation/**
  workflow_dispatch: { }

jobs:
  # 1. 编译检查 Job
  java-check:
    name: Java Code Check (JDK 11)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'adopt'
      # ... 其他步骤 ...
      - name: Compile Code for Errors
        run: mvn -B compile --no-transfer-progress

  # 2. 构建和测试 Job
  java-test:
    name: Build and Test (${{ matrix.java }})
    runs-on: ubuntu-latest
    needs: java-check # 依赖于 java-check 必须成功
    strategy:
      matrix:
        java: [ '8', '11', '17', '20' ]
    steps:
      - uses: actions/checkout@v4
      # ... 其他步骤 ...
      - name: Run tests with coverage
        run: mvn -B clean test package --no-transfer-progress

  # 3. 自动更新版本 Job
  version-bump:
    name: Auto Bump Version and Commit
    runs-on: ubuntu-latest
    # 这一步必须依赖前面的所有测试，确保只有在代码成功通过测试后才更新版本
    needs: [java-check, java-test]

    # 仅在推送到 master 分支时运行，避免在 PR 或其他分支上自动提交
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        with:
          # 必须使用 token 才能提交
          token: ${{ secrets.ADYEN_AUTOMATION_BOT_ACCESS_TOKEN }}

      - name: 2. Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: 3. Update POM and Extract New Version
        # ... (步骤内容与上一个回复中提供的一致)
        run: |
          echo "--- Updating pom.xml to next SNAPSHOT ---"
          mvn versions:set -DnextSnapshot=true -B
          mvn versions:commit -B
          NEW_VERSION=$(grep -m 1 '<version>' pom.xml | awk -F'[<>]' '/version/{print $3}')
          echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV
          echo "New Version: ${NEW_VERSION} has been extracted."

      - name: 4. Update Version in README File
        # ... (步骤内容与上一个回复中提供的一致)
        run: |
          echo "--- Updating README file ---"
          README_FILE="README.md" # 确认文件名
          sed -i 's#<version>[0-9A-Za-z.]*</version>#<version>${{ env.NEW_VERSION }}</version>#g' $README_FILE
          echo "Successfully updated version in $README_FILE."

      - name: 5. Commit and Push the updated files
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(release): Bump version to ${{ env.NEW_VERSION }}"
          files: |
            pom.xml
            README.md # 确认文件名
          commit_options: '--no-verify'
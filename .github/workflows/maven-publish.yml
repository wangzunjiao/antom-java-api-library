name: ğŸ“¦ Maven Publish to Central

on:
  # ä»…åœ¨åˆ›å»ºæ–°çš„ Tag æ—¶è§¦å‘å‘å¸ƒï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  # å…è®¸æ‰‹åŠ¨ä» Actions é¡µé¢è§¦å‘
  workflow_dispatch:

jobs:
  publish:
    name: Publish Release
    runs-on: ubuntu-latest

    # ç¡®ä¿åªæœ‰åœ¨ Tag ä¸Šè¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      - name: 2. Set up JDK 17 and Maven Settings
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'
          # --- Maven Central è®¤è¯é…ç½® ---
          # å‘Šè¯‰ setup-java æ³¨å…¥è¿™äº›å‡­è¯åˆ° settings.xml
          server-id: ossrh
          server-username: ${{ secrets.OSSRH_USERNAME }}
          server-password: ${{ secrets.OSSRH_PASSWORD }}

          # --- GPG ç­¾åé…ç½® ---
          # å¯¼å…¥ç”¨äºç­¾åçš„ GPG ç§é’¥
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          # è®¾ç½® GPG å¯†ç 
          gpg-passphrase: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

          # é…ç½® settings.xml è·¯å¾„ (é»˜è®¤åœ¨ runner ä¸Šçš„ .m2 ç›®å½•ä¸‹)
          settings-path: ${{ github.workspace }}

      - name: 3. Set Release Version from Tag
        id: set_version
        run: |
          # æå– Tag åä½œä¸ºç‰ˆæœ¬å· (ä¾‹å¦‚ï¼šrefs/tags/v1.2.3 -> 1.2.3)
          RELEASE_VERSION=${GITHUB_REF##*/}
          # ç§»é™¤å‰ç¼€ 'v'
          VERSION=${RELEASE_VERSION#v}
          echo "::set-output name=version::$VERSION"
          echo "Extracted release version: $VERSION"

      # å¯é€‰ï¼šå¦‚æœæ‚¨çš„ pom.xml ä¸­çš„ç‰ˆæœ¬å·æ˜¯ SNAPSHOTï¼Œæ‚¨å¯èƒ½éœ€è¦å…ˆæ›´æ–°ç‰ˆæœ¬
      - name: 4. Update POM Version (If needed)
        run: |
          # è¿™ä¸€æ­¥å°†é¡¹ç›®ç‰ˆæœ¬è®¾ç½®ä¸º Tag ç‰ˆæœ¬ï¼Œé¿å… SNAPSHOT ç‰ˆæœ¬å‘å¸ƒ
          mvn versions:set -DnewVersion=${{ steps.set_version.outputs.version }} -B
          mvn versions:commit -B

      - name: 5. Build, Sign, and Deploy to Maven Central
        run: |
          echo "Starting deployment of version ${{ steps.set_version.outputs.version }}"
          # -B: æ‰¹å¤„ç†æ¨¡å¼
          # -P release: æ¿€æ´» pom.xml ä¸­é…ç½®çš„ release profile (é€šå¸¸åŒ…å« GPG ç­¾åé…ç½®)
          # deploy: æ‰§è¡Œéƒ¨ç½²
          # settings-file: ä½¿ç”¨ setup-java ç”Ÿæˆçš„åŒ…å«è®¤è¯ä¿¡æ¯çš„ settings.xml
          mvn clean deploy -B -P release \
            --settings ${{ github.workspace }}/settings.xml
        env:
          # æ˜¾å¼ä¼ é€’ GPG å¯†ç ï¼Œç¡®ä¿ GPG ç­¾åæˆåŠŸ
          GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: 6. Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.set_version.outputs.version }}
          draft: false
          prerelease: false